<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DAZN Schedule Browser</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    /* Theme Variables */
    :root {
      --bg-primary: #0a0f1a;
      --bg-secondary: #0d1929;
      --bg-card: #132337;
      --bg-card-secondary: #1a3049;
      --text-primary: #f0f0f0;
      --text-secondary: #888;
      --accent-primary: #3b82f6;
      --accent-secondary: #60a5fa;
      --accent-gradient: linear-gradient(135deg, #3b82f6, #60a5fa);
      --btn-bg: rgba(255,255,255,0.1);
      --btn-border: rgba(255,255,255,0.2);
      --card-border: rgba(255,255,255,0.08);
      --live-color: #ef4444;
    }

    [data-theme="crimson"] {
      --bg-primary: #0a0a0f;
      --bg-secondary: #150a18;
      --bg-card: #1f1025;
      --bg-card-secondary: #2d1833;
      --accent-primary: #ec4899;
      --accent-secondary: #f472b6;
      --accent-gradient: linear-gradient(135deg, #ec4899, #f472b6);
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
      color: var(--text-primary);
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin: 0;
      color: var(--text-primary);
    }

    .header p {
      color: #888;
      margin-top: 5px;
    }

    /* Controls Section */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }

    .date-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-nav-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
    }

    .date-nav-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }

    .date-nav-btn.active {
      background: var(--accent-primary);
      border-color: transparent;
    }

    #datePicker {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
    }

    #datePicker::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .country-wrapper {
      position: relative;
    }

    #countryPicker {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      min-width: 200px;
      appearance: none;
      -webkit-appearance: none;
    }

    #countryPicker option {
      background: #1a1a2e;
      color: #fff;
      padding: 10px;
    }

    .go-btn {
      background: var(--accent-primary);
      border: none;
      color: #fff;
      padding: 12px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .go-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      filter: brightness(1.1);
    }

    .go-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .stat-badge.primary {
      background: var(--accent-primary);
    }

    /* Sport Filter Tabs */
    .sport-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .sport-tab {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: #aaa;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .sport-tab:hover {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .sport-tab.active {
      background: var(--accent-primary);
      border-color: transparent;
      color: #fff;
    }

    .sport-tab .count {
      background: rgba(0,0,0,0.3);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
      font-size: 0.8rem;
    }

    /* Event Container */
    #eventContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Event Cards */
    .eventCard {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid var(--card-border);
      position: relative;
    }

    .eventCard:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
      border-color: var(--accent-primary);
    }

    .eventCard .image-wrapper {
      position: relative;
      overflow: hidden;
    }

    .eventCard img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .eventCard:hover img {
      transform: scale(1.05);
    }

    .eventCard .no-image {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #2d2d44, #1a1a2e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #444;
    }

    .live-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #ef4444;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .sport-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .eventCard .content {
      padding: 16px;
    }

    .eventCard .competition {
      font-size: 0.8rem;
      color: var(--accent-secondary);
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .eventCard h3 {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.3;
      color: #fff;
    }

    .eventCard .time-info {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #888;
      font-size: 0.85rem;
    }

    .eventCard .time-info svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #888;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    #eventDetails {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-content {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      max-width: 500px;
      margin: 50px auto;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .modal-content img {
      width: 100%;
      height: 220px;
      object-fit: cover;
    }

    .modal-content .modal-body {
      padding: 24px;
    }

    .modal-content h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: #fff;
    }

    .modal-content .competition-tag {
      display: inline-block;
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-bottom: 16px;
    }

    .modal-content .description {
      color: #aaa;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .modal-content .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-content .info-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 10px;
    }

    .modal-content .info-item label {
      display: block;
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .modal-content .info-item span {
      font-weight: 500;
      color: #fff;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.6);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: rgba(0,0,0,0.8);
      transform: scale(1.1);
    }

    /* Empty/Error States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #f87171;
    }

    /* Analytics Button */
    .analytics-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .analytics-btn:hover {
      background: var(--accent-primary);
      border-color: transparent;
    }

    .analytics-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Analytics Modal */
    #analyticsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      padding: 20px;
      overflow-y: auto;
    }

    .analytics-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .analytics-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .analytics-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .analytics-close:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Quick Stats Grid */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .quick-stat-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid var(--card-border);
    }

    .quick-stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--accent-secondary);
    }

    .quick-stat-card .label {
      font-size: 0.85rem;
      color: #888;
      margin-top: 5px;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--card-border);
    }

    .chart-card h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      color: #fff;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Top Events Table */
    .top-events-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--card-border);
    }

    .top-events-card h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      color: #fff;
    }

    .top-events-table {
      width: 100%;
      border-collapse: collapse;
    }

    .top-events-table th,
    .top-events-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .top-events-table th {
      color: #888;
      font-weight: 500;
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .top-events-table td {
      color: #fff;
      font-size: 0.9rem;
    }

    .top-events-table tr:last-child td {
      border-bottom: none;
    }

    .top-events-table .rank {
      width: 40px;
      color: var(--accent-primary);
      font-weight: 700;
    }

    .top-events-table .duration {
      color: var(--accent-secondary);
      font-weight: 600;
    }

    .top-events-table .sport-cell {
      color: #888;
      font-size: 0.85rem;
    }

    /* Heatmap Styles */
    .heatmap-container {
      display: grid;
      grid-template-columns: 60px repeat(24, 1fr);
      gap: 2px;
      margin-top: 10px;
    }

    .heatmap-row {
      display: contents;
    }

    .heatmap-label {
      font-size: 0.75rem;
      color: #888;
      display: flex;
      align-items: center;
      padding-right: 8px;
    }

    .heatmap-cell {
      aspect-ratio: 1;
      border-radius: 3px;
      min-height: 20px;
      transition: transform 0.2s;
      cursor: pointer;
      position: relative;
    }

    .heatmap-cell:hover {
      transform: scale(1.2);
      z-index: 10;
    }

    .heatmap-cell[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.9);
      color: white;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      z-index: 100;
    }

    .heatmap-header {
      font-size: 0.65rem;
      color: #666;
      text-align: center;
      padding-bottom: 4px;
    }

    .heatmap-legend {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-top: 15px;
      font-size: 0.8rem;
      color: #888;
    }

    .heatmap-gradient {
      width: 120px;
      height: 12px;
      border-radius: 4px;
      background: linear-gradient(to right, #1e1e2e, #3b1d5c, #7c3aed, #00d4ff);
    }

    /* Compare Button */
    .compare-btn {
      background: var(--btn-bg);
      border: 1px solid var(--btn-border);
      color: #fff;
      padding: 12px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 500;
      transition: all 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .compare-btn:hover {
      background: var(--accent-primary);
      border-color: transparent;
    }

    /* Comparison Modal */
    #compareModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      padding: 20px;
      overflow-y: auto;
    }

    .compare-container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .compare-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
    }

    .compare-header h2 {
      margin: 0;
      font-size: 1.5rem;
      color: var(--text-primary);
    }

    .compare-setup {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid var(--card-border);
    }

    .compare-setup h3 {
      margin: 0 0 15px 0;
      color: var(--text-primary);
    }

    .country-checkboxes {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
      max-height: 300px;
      overflow-y: auto;
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
    }

    .country-checkbox {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--btn-bg);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .country-checkbox:hover {
      background: rgba(255,255,255,0.15);
    }

    .country-checkbox input {
      cursor: pointer;
    }

    .country-checkbox.selected {
      background: var(--accent-primary);
    }

    .compare-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .compare-run-btn {
      background: var(--accent-primary);
      border: none;
      color: #fff;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
    }

    .compare-run-btn:hover {
      filter: brightness(1.1);
    }

    .compare-run-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Comparison Results */
    .compare-results {
      display: none;
    }

    .compare-stats-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 25px;
    }

    .country-stat-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--card-border);
    }

    .country-stat-card h4 {
      margin: 0 0 15px 0;
      color: var(--accent-secondary);
      font-size: 1.1rem;
    }

    .country-stat-card .stat-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid var(--card-border);
    }

    .country-stat-card .stat-row:last-child {
      border-bottom: none;
    }

    .country-stat-card .stat-label {
      color: var(--text-secondary);
    }

    .country-stat-card .stat-value {
      color: var(--text-primary);
      font-weight: 600;
    }

    .compare-chart-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .exclusive-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 20px;
    }

    .exclusive-card {
      background: linear-gradient(145deg, var(--bg-card), var(--bg-card-secondary));
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--card-border);
    }

    .exclusive-card h4 {
      margin: 0 0 15px 0;
      color: var(--accent-secondary);
    }

    .exclusive-list {
      max-height: 300px;
      overflow-y: auto;
    }

    .exclusive-item {
      padding: 10px;
      background: rgba(0,0,0,0.2);
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .exclusive-item .title {
      font-weight: 500;
      color: var(--text-primary);
    }

    .exclusive-item .meta {
      font-size: 0.85rem;
      color: var(--text-secondary);
      margin-top: 4px;
    }

    .shared-badge {
      display: inline-block;
      background: var(--accent-primary);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
      margin-left: 8px;
    }

    /* Theme Toggle Switch */
    .theme-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .theme-toggle-label {
      font-size: 0.85rem;
      color: var(--text-secondary);
      transition: color 0.3s;
    }

    .theme-toggle-label.active {
      color: var(--accent-secondary);
      font-weight: 600;
    }

    .toggle-switch {
      position: relative;
      width: 50px;
      height: 26px;
      cursor: pointer;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--accent-primary);
      border-radius: 26px;
      transition: all 0.3s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 20px;
      width: 20px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s;
    }

    .toggle-switch input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      #controls {
        padding: 15px;
      }

      .date-section {
        width: 100%;
        justify-content: center;
      }

      #eventContainer {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-wrapper {
        height: 250px;
      }

      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>DAZN Schedule Browser</h1>
    <p>Browse sports events from around the world</p>
    <div class="theme-toggle">
      <span class="theme-toggle-label" id="labelBlue">Ocean Blue</span>
      <label class="toggle-switch">
        <input type="checkbox" id="themeToggle" onchange="toggleTheme()">
        <span class="toggle-slider"></span>
      </label>
      <span class="theme-toggle-label" id="labelCrimson">Crimson</span>
    </div>
  </div>

  <div id="controls">
    <div class="date-section">
      <button class="date-nav-btn" onclick="changeDate(-1)">&#9664;</button>
      <button class="date-nav-btn" id="todayBtn" onclick="setToday()">Today</button>
      <input type="date" id="datePicker">
      <button class="date-nav-btn" id="tomorrowBtn" onclick="setTomorrow()">Tomorrow</button>
      <button class="date-nav-btn" onclick="changeDate(1)">&#9654;</button>
    </div>

    <div class="country-wrapper">
      <select id="countryPicker">
        <option value="us">&#x1F1FA;&#x1F1F8; United States</option>
        <option value="ca">&#x1F1E8;&#x1F1E6; Canada</option>
        <option value="gb">&#x1F1EC;&#x1F1E7; United Kingdom</option>
        <option value="de">&#x1F1E9;&#x1F1EA; Germany</option>
        <option value="fr">&#x1F1EB;&#x1F1F7; France</option>
        <option value="es">&#x1F1EA;&#x1F1F8; Spain</option>
        <option value="it">&#x1F1EE;&#x1F1F9; Italy</option>
        <option value="au">&#x1F1E6;&#x1F1FA; Australia</option>
        <option value="nz">&#x1F1F3;&#x1F1FF; New Zealand</option>
        <option value="jp">&#x1F1EF;&#x1F1F5; Japan</option>
        <option value="kr">&#x1F1F0;&#x1F1F7; South Korea</option>
        <option value="mx">&#x1F1F2;&#x1F1FD; Mexico</option>
        <option value="br">&#x1F1E7;&#x1F1F7; Brazil</option>
        <option value="ar">&#x1F1E6;&#x1F1F7; Argentina</option>
        <option value="se">&#x1F1F8;&#x1F1EA; Sweden</option>
        <option value="no">&#x1F1F3;&#x1F1F4; Norway</option>
        <option value="fi">&#x1F1EB;&#x1F1EE; Finland</option>
        <option value="dk">&#x1F1E9;&#x1F1F0; Denmark</option>
        <option value="nl">&#x1F1F3;&#x1F1F1; Netherlands</option>
        <option value="be">&#x1F1E7;&#x1F1EA; Belgium</option>
        <option value="ch">&#x1F1E8;&#x1F1ED; Switzerland</option>
        <option value="at">&#x1F1E6;&#x1F1F9; Austria</option>
        <option value="ie">&#x1F1EE;&#x1F1EA; Ireland</option>
        <option value="pl">&#x1F1F5;&#x1F1F1; Poland</option>
        <option value="pt">&#x1F1F5;&#x1F1F9; Portugal</option>
        <option value="cz">&#x1F1E8;&#x1F1FF; Czech Republic</option>
        <option value="hu">&#x1F1ED;&#x1F1FA; Hungary</option>
        <option value="gr">&#x1F1EC;&#x1F1F7; Greece</option>
        <option value="ro">&#x1F1F7;&#x1F1F4; Romania</option>
        <option value="bg">&#x1F1E7;&#x1F1EC; Bulgaria</option>
        <option value="ru">&#x1F1F7;&#x1F1FA; Russia</option>
        <option value="cn">&#x1F1E8;&#x1F1F3; China</option>
        <option value="in">&#x1F1EE;&#x1F1F3; India</option>
        <option value="za">&#x1F1FF;&#x1F1E6; South Africa</option>
        <option value="ae">&#x1F1E6;&#x1F1EA; United Arab Emirates</option>
        <option value="tr">&#x1F1F9;&#x1F1F7; Turkey</option>
        <option value="il">&#x1F1EE;&#x1F1F1; Israel</option>
        <option value="sg">&#x1F1F8;&#x1F1EC; Singapore</option>
        <option value="hk">&#x1F1ED;&#x1F1F0; Hong Kong</option>
      </select>
    </div>

    <button class="go-btn" id="goBtn" onclick="loadEPG()">Load Events</button>
    <button class="compare-btn" onclick="openCompare()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor"><path d="M10 3H4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zM9 9H5V5h4v4zm11-6h-6a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zm-1 6h-4V5h4v4zm-9 4H4a1 1 0 0 0-1 1v6a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1v-6a1 1 0 0 0-1-1zm-1 6H5v-4h4v4zm8-6c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm0 6c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2z"/></svg>
      Compare Countries
    </button>
  </div>

  <div class="stats-bar" id="statsBar" style="display: none;">
    <span class="stat-badge primary" id="eventCount"></span>
    <span class="stat-badge" id="dateDisplay"></span>
    <button class="analytics-btn" id="analyticsBtn" onclick="openAnalytics()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
      Analytics
    </button>
  </div>

  <div class="sport-filters" id="sportFilters" style="display: none;"></div>

  <div id="eventContainer"></div>

  <div id="eventDetails">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Compare Countries Modal -->
  <div id="compareModal">
    <div class="compare-container">
      <div class="compare-header">
        <h2 id="compareTitle">Compare Countries</h2>
        <button class="analytics-close" onclick="closeCompare()">&times;</button>
      </div>

      <div class="compare-setup">
        <h3>Select Countries to Compare (2-4)</h3>
        <div class="country-checkboxes" id="countryCheckboxes"></div>
        <div class="compare-actions">
          <button class="compare-run-btn" id="runCompareBtn" onclick="runComparison()" disabled>Compare Selected Countries</button>
          <span id="selectedCount" style="color: var(--text-secondary); align-self: center;">0 selected</span>
        </div>
      </div>

      <div class="compare-results" id="compareResults">
        <div class="compare-stats-row" id="countryStats"></div>

        <div class="compare-chart-grid">
          <div class="chart-card">
            <h3>Events by Country</h3>
            <div class="chart-wrapper">
              <canvas id="compareEventsChart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <h3>Sports Availability</h3>
            <div class="chart-wrapper">
              <canvas id="compareSportsChart"></canvas>
            </div>
          </div>
        </div>

        <div class="exclusive-content" id="exclusiveContent"></div>
      </div>
    </div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModal">
    <div class="analytics-container">
      <div class="analytics-header">
        <h2>Daily Analytics</h2>
        <button class="analytics-close" onclick="closeAnalytics()">&times;</button>
      </div>

      <div class="quick-stats" id="quickStats"></div>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>Events by Sport</h3>
          <div class="chart-wrapper">
            <canvas id="sportsPieChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Events by Hour</h3>
          <div class="chart-wrapper">
            <canvas id="hourlyBarChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Broadcast Hours by Sport</h3>
          <div class="chart-wrapper">
            <canvas id="broadcastHoursChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Top Competitions</h3>
          <div class="chart-wrapper">
            <canvas id="competitionsChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Subscription vs PPV</h3>
          <div class="chart-wrapper">
            <canvas id="accessChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Video Quality Features</h3>
          <div class="chart-wrapper">
            <canvas id="qualityChart"></canvas>
          </div>
        </div>
      </div>

      <div class="chart-card" style="margin-bottom: 20px;">
        <h3>Events by Time of Day</h3>
        <div class="heatmap-container" id="timeHeatmap"></div>
        <div class="heatmap-legend">
          <span>Less</span>
          <div class="heatmap-gradient"></div>
          <span>More</span>
        </div>
      </div>

      <div class="top-events-card">
        <h3>Longest Broadcasts</h3>
        <table class="top-events-table" id="topEventsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Event</th>
              <th>Sport</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody id="topEventsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const eventContainer = document.getElementById("eventContainer");
    const statsBar = document.getElementById("statsBar");
    const sportFilters = document.getElementById("sportFilters");
    let allEvents = [];
    let currentFilter = 'all';

    // Sport icons mapping
    const sportIcons = {
      'Soccer': '&#9917;',
      'Football': '&#127944;',
      'Basketball': '&#127936;',
      'Baseball': '&#9918;',
      'Hockey': '&#127954;',
      'Tennis': '&#127934;',
      'Golf': '&#9971;',
      'Boxing': '&#129354;',
      'MMA': '&#129354;',
      'UFC': '&#129354;',
      'Racing': '&#127950;',
      'Motor Sports': '&#127950;',
      'Cricket': '&#127951;',
      'Rugby': '&#127937;',
      'default': '&#127941;'
    };

    function getSportIcon(sportTitle) {
      for (const [key, icon] of Object.entries(sportIcons)) {
        if (sportTitle && sportTitle.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return sportIcons.default;
    }

    // Initialize with today's date
    function initDatePicker() {
      const today = new Date();
      const formatted = today.toISOString().split('T')[0];
      document.getElementById('datePicker').value = formatted;
      updateDateButtons();
    }

    function setToday() {
      const today = new Date();
      document.getElementById('datePicker').value = today.toISOString().split('T')[0];
      updateDateButtons();
    }

    function setTomorrow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('datePicker').value = tomorrow.toISOString().split('T')[0];
      updateDateButtons();
    }

    function changeDate(days) {
      const picker = document.getElementById('datePicker');
      const current = new Date(picker.value);
      current.setDate(current.getDate() + days);
      picker.value = current.toISOString().split('T')[0];
      updateDateButtons();
    }

    function updateDateButtons() {
      const picker = document.getElementById('datePicker');
      const selected = picker.value;
      const today = new Date().toISOString().split('T')[0];
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];

      document.getElementById('todayBtn').classList.toggle('active', selected === today);
      document.getElementById('tomorrowBtn').classList.toggle('active', selected === tomorrowStr);
    }

    document.getElementById('datePicker').addEventListener('change', updateDateButtons);

    function showLoading() {
      eventContainer.innerHTML = `
        <div class="loading" style="grid-column: 1 / -1;">
          <div class="spinner"></div>
          <p>Loading events...</p>
        </div>
      `;
      statsBar.style.display = 'none';
      sportFilters.style.display = 'none';
    }

    function isEventLive(event) {
      const now = new Date();
      const start = new Date(event.Start);
      const end = new Date(event.End);
      return now >= start && now <= end;
    }

    function formatTime(dateStr) {
      return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function showEventDetails(eventData) {
      const modal = document.getElementById("eventDetails");
      const content = document.getElementById("modalContent");
      const imgId = eventData.Image?.Id;
      const imageUrl = imgId ? `https://image.discovery.indazn.com/ca/v3/ca/none/${imgId}/fill/none/top/none/50/500/280/webp/image` : "";

      content.innerHTML = `
        <button class="close-btn" onclick="closeModal()">&times;</button>
        ${imageUrl ? `<img src="${imageUrl}" alt="Event image">` : `<div class="no-image" style="height:220px;">${getSportIcon(eventData.Sport?.Title)}</div>`}
        <div class="modal-body">
          <h2>${eventData.Title}</h2>
          ${eventData.Competition?.Title ? `<span class="competition-tag">${eventData.Competition.Title}</span>` : ''}
          ${eventData.Description ? `<p class="description">${eventData.Description}</p>` : ''}
          <div class="info-grid">
            <div class="info-item">
              <label>Sport</label>
              <span>${eventData.Sport?.Title || 'N/A'}</span>
            </div>
            <div class="info-item">
              <label>Status</label>
              <span>${isEventLive(eventData) ? '&#x1F534; LIVE' : 'Scheduled'}</span>
            </div>
            <div class="info-item">
              <label>Start Time</label>
              <span>${formatTime(eventData.Start)}</span>
            </div>
            <div class="info-item">
              <label>End Time</label>
              <span>${formatTime(eventData.End)}</span>
            </div>
          </div>
        </div>
      `;

      modal.style.display = "block";
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      document.getElementById("eventDetails").style.display = "none";
      document.body.style.overflow = "auto";
    }

    document.getElementById("eventDetails").addEventListener("click", (e) => {
      if (e.target.id === "eventDetails") closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    function buildSportFilters(events) {
      const sportCounts = {};
      events.forEach(e => {
        const sport = e.Sport?.Title || 'Other';
        sportCounts[sport] = (sportCounts[sport] || 0) + 1;
      });

      const sorted = Object.entries(sportCounts).sort((a, b) => b[1] - a[1]);

      let html = `<button class="sport-tab ${currentFilter === 'all' ? 'active' : ''}" onclick="filterBySport('all')">
        All<span class="count">${events.length}</span>
      </button>`;

      sorted.forEach(([sport, count]) => {
        html += `<button class="sport-tab ${currentFilter === sport ? 'active' : ''}" onclick="filterBySport('${sport.replace(/'/g, "\\'")}')">
          ${sport}<span class="count">${count}</span>
        </button>`;
      });

      sportFilters.innerHTML = html;
      sportFilters.style.display = 'flex';
    }

    function filterBySport(sport) {
      currentFilter = sport;
      renderEvents(allEvents);
      buildSportFilters(allEvents);
    }

    function renderEvents(events) {
      const filtered = currentFilter === 'all'
        ? events
        : events.filter(e => (e.Sport?.Title || 'Other') === currentFilter);

      if (filtered.length === 0) {
        eventContainer.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="icon">&#128531;</div>
            <h3>No events found</h3>
            <p>Try selecting a different sport or date</p>
          </div>
        `;
        return;
      }

      // Sort by start time
      filtered.sort((a, b) => new Date(a.Start) - new Date(b.Start));

      eventContainer.innerHTML = '';
      filtered.forEach(event => {
        const eventCard = document.createElement("div");
        eventCard.className = "eventCard";

        const imgId = event.Image?.Id;
        const imageUrl = imgId ? `https://image.discovery.indazn.com/ca/v3/ca/none/${imgId}/fill/none/top/none/50/334/187/webp/image` : "";
        const isLive = isEventLive(event);
        const sportTitle = event.Sport?.Title || 'Sports';

        eventCard.innerHTML = `
          <div class="image-wrapper">
            ${imageUrl
              ? `<img src="${imageUrl}" alt="Event image" loading="lazy">`
              : `<div class="no-image">${getSportIcon(sportTitle)}</div>`}
            ${isLive ? '<div class="live-badge">Live</div>' : ''}
            <div class="sport-badge">${sportTitle}</div>
          </div>
          <div class="content">
            ${event.Competition?.Title ? `<div class="competition">${event.Competition.Title}</div>` : ''}
            <h3>${event.Title}</h3>
            <div class="time-info">
              <svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
              <span>${formatTime(event.Start)} - ${formatTime(event.End)}</span>
            </div>
          </div>
        `;

        eventCard.addEventListener("click", () => showEventDetails(event));
        eventContainer.appendChild(eventCard);
      });
    }

    function loadEPG() {
      const date = document.getElementById("datePicker").value;
      const country = document.getElementById("countryPicker").value;
      const epgUrl = `https://epg.discovery.indazn.com/ca/v2/Epg?date=${date}&country=${country}&languageCode=en&openBrowse=false&timeZoneOffset=-300`;

      showLoading();
      currentFilter = 'all';

      fetch(epgUrl)
        .then(response => response.json())
        .then(data => {
          const jsonString = JSON.stringify(data);
          if (jsonString.includes("Invalid Country.")) {
            eventContainer.innerHTML = `
              <div class="error-state" style="grid-column: 1 / -1;">
                <h3>&#9888; Country Not Supported</h3>
                <p>The selected country is not available from the EPG provider.</p>
              </div>
            `;
            statsBar.style.display = 'none';
            sportFilters.style.display = 'none';
            return;
          }

          allEvents = data.Tiles || [];

          if (allEvents.length === 0) {
            eventContainer.innerHTML = `
              <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="icon">&#128247;</div>
                <h3>No events scheduled</h3>
                <p>There are no events for this date and country</p>
              </div>
            `;
            statsBar.style.display = 'none';
            sportFilters.style.display = 'none';
            return;
          }

          // Update stats
          document.getElementById("eventCount").textContent = `${allEvents.length} Events`;
          document.getElementById("dateDisplay").textContent = formatDate(date);
          statsBar.style.display = 'flex';

          buildSportFilters(allEvents);
          renderEvents(allEvents);
        })
        .catch(error => {
          console.error("Error fetching EPG:", error);
          eventContainer.innerHTML = `
            <div class="error-state" style="grid-column: 1 / -1;">
              <h3>&#10060; Failed to Load</h3>
              <p>Could not fetch EPG data. Please try again.</p>
            </div>
          `;
          statsBar.style.display = 'none';
          sportFilters.style.display = 'none';
        });
    }

    // Theme switching
    function toggleTheme() {
      const toggle = document.getElementById('themeToggle');
      const isCrimson = toggle.checked;

      if (isCrimson) {
        document.documentElement.setAttribute('data-theme', 'crimson');
      } else {
        document.documentElement.removeAttribute('data-theme');
      }

      // Update labels
      document.getElementById('labelBlue').classList.toggle('active', !isCrimson);
      document.getElementById('labelCrimson').classList.toggle('active', isCrimson);

      // Save preference
      localStorage.setItem('dazn-epg-theme', isCrimson ? 'crimson' : 'blue');
    }

    // Load saved theme on page load
    function loadSavedTheme() {
      const savedTheme = localStorage.getItem('dazn-epg-theme');
      const toggle = document.getElementById('themeToggle');

      if (savedTheme === 'crimson') {
        toggle.checked = true;
        document.documentElement.setAttribute('data-theme', 'crimson');
        document.getElementById('labelCrimson').classList.add('active');
      } else {
        toggle.checked = false;
        document.documentElement.removeAttribute('data-theme');
        document.getElementById('labelBlue').classList.add('active');
      }
    }

    // Country comparison functionality
    let compareChartInstances = {};
    const countryList = [
      { code: 'us', name: 'United States', flag: '\u{1F1FA}\u{1F1F8}' },
      { code: 'ca', name: 'Canada', flag: '\u{1F1E8}\u{1F1E6}' },
      { code: 'gb', name: 'United Kingdom', flag: '\u{1F1EC}\u{1F1E7}' },
      { code: 'de', name: 'Germany', flag: '\u{1F1E9}\u{1F1EA}' },
      { code: 'fr', name: 'France', flag: '\u{1F1EB}\u{1F1F7}' },
      { code: 'es', name: 'Spain', flag: '\u{1F1EA}\u{1F1F8}' },
      { code: 'it', name: 'Italy', flag: '\u{1F1EE}\u{1F1F9}' },
      { code: 'au', name: 'Australia', flag: '\u{1F1E6}\u{1F1FA}' },
      { code: 'jp', name: 'Japan', flag: '\u{1F1EF}\u{1F1F5}' },
      { code: 'br', name: 'Brazil', flag: '\u{1F1E7}\u{1F1F7}' },
      { code: 'mx', name: 'Mexico', flag: '\u{1F1F2}\u{1F1FD}' },
      { code: 'nl', name: 'Netherlands', flag: '\u{1F1F3}\u{1F1F1}' },
      { code: 'at', name: 'Austria', flag: '\u{1F1E6}\u{1F1F9}' },
      { code: 'ch', name: 'Switzerland', flag: '\u{1F1E8}\u{1F1ED}' },
      { code: 'pl', name: 'Poland', flag: '\u{1F1F5}\u{1F1F1}' },
      { code: 'se', name: 'Sweden', flag: '\u{1F1F8}\u{1F1EA}' }
    ];

    function openCompare() {
      document.getElementById('compareModal').style.display = 'block';
      document.body.style.overflow = 'hidden';
      buildCountryCheckboxes();

      const dateStr = document.getElementById('datePicker').value;
      const [year, month, day] = dateStr.split('-');
      const dateObj = new Date(year, month - 1, day);
      const formattedDate = dateObj.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });
      document.getElementById('compareTitle').textContent = `Compare Countries - ${formattedDate}`;
    }

    function closeCompare() {
      document.getElementById('compareModal').style.display = 'none';
      document.body.style.overflow = 'auto';
      Object.values(compareChartInstances).forEach(chart => chart.destroy());
      compareChartInstances = {};
    }

    document.getElementById('compareModal').addEventListener('click', (e) => {
      if (e.target.id === 'compareModal') closeCompare();
    });

    function buildCountryCheckboxes() {
      const container = document.getElementById('countryCheckboxes');
      container.innerHTML = countryList.map(c => `
        <label class="country-checkbox">
          <input type="checkbox" value="${c.code}" onchange="updateSelectedCount()">
          ${c.flag} ${c.name}
        </label>
      `).join('');
      updateSelectedCount();
      document.getElementById('compareResults').style.display = 'none';
    }

    function updateSelectedCount() {
      const checked = document.querySelectorAll('#countryCheckboxes input:checked');
      const count = checked.length;
      document.getElementById('selectedCount').textContent = `${count} selected`;
      document.getElementById('runCompareBtn').disabled = count < 2 || count > 4;

      // Update visual selection
      document.querySelectorAll('.country-checkbox').forEach(label => {
        const input = label.querySelector('input');
        label.classList.toggle('selected', input.checked);
      });
    }

    async function runComparison() {
      const checked = document.querySelectorAll('#countryCheckboxes input:checked');
      const selectedCodes = Array.from(checked).map(input => input.value);
      const date = document.getElementById('datePicker').value;

      document.getElementById('runCompareBtn').disabled = true;
      document.getElementById('runCompareBtn').textContent = 'Loading...';

      try {
        const results = await Promise.all(selectedCodes.map(async code => {
          const url = `https://epg.discovery.indazn.com/ca/v2/Epg?date=${date}&country=${code}&languageCode=en&openBrowse=false&timeZoneOffset=-300`;
          const response = await fetch(url);
          const data = await response.json();
          const countryInfo = countryList.find(c => c.code === code);
          return {
            code,
            name: countryInfo?.name || code.toUpperCase(),
            flag: countryInfo?.flag || '',
            events: data.Tiles || [],
            error: JSON.stringify(data).includes("Invalid Country.")
          };
        }));

        displayComparisonResults(results);
      } catch (error) {
        console.error('Comparison error:', error);
        alert('Error fetching comparison data');
      }

      document.getElementById('runCompareBtn').disabled = false;
      document.getElementById('runCompareBtn').textContent = 'Compare Selected Countries';
    }

    function displayComparisonResults(results) {
      document.getElementById('compareResults').style.display = 'block';

      // Destroy old charts
      Object.values(compareChartInstances).forEach(chart => chart.destroy());
      compareChartInstances = {};

      const colors = ['#3b82f6', '#ec4899', '#22c55e', '#f97316'];

      // Build country stat cards
      let statsHTML = '';
      results.forEach((r, i) => {
        if (r.error) {
          statsHTML += `<div class="country-stat-card"><h4>${r.flag} ${r.name}</h4><p style="color: var(--live-color);">Not available in this region</p></div>`;
          return;
        }

        const events = r.events.filter(e =>
          !e.Title?.toLowerCase().includes('live tv') &&
          !e.Sport?.Title?.toLowerCase().includes('live tv')
        );

        const sports = [...new Set(events.map(e => e.Sport?.Title).filter(Boolean))];
        const competitions = [...new Set(events.map(e => e.Competition?.Title).filter(Boolean))];
        const ppvCount = events.filter(e => (e.EntitlementIds || []).some(id => id.toLowerCase().includes('ppv'))).length;

        statsHTML += `
          <div class="country-stat-card" style="border-top: 3px solid ${colors[i]}">
            <h4>${r.flag} ${r.name}</h4>
            <div class="stat-row"><span class="stat-label">Total Events</span><span class="stat-value">${events.length}</span></div>
            <div class="stat-row"><span class="stat-label">Sports</span><span class="stat-value">${sports.length}</span></div>
            <div class="stat-row"><span class="stat-label">Competitions</span><span class="stat-value">${competitions.length}</span></div>
            <div class="stat-row"><span class="stat-label">PPV Events</span><span class="stat-value">${ppvCount}</span></div>
          </div>
        `;

        r.filteredEvents = events;
        r.sports = sports;
      });
      document.getElementById('countryStats').innerHTML = statsHTML;

      // Events comparison bar chart
      const validResults = results.filter(r => !r.error);
      compareChartInstances.events = new Chart(document.getElementById('compareEventsChart'), {
        type: 'bar',
        data: {
          labels: validResults.map(r => r.name),
          datasets: [{
            label: 'Events',
            data: validResults.map(r => r.filteredEvents?.length || 0),
            backgroundColor: colors.slice(0, validResults.length),
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#fff' } },
            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#888' }, beginAtZero: true }
          }
        }
      });

      // Sports availability comparison
      const allSports = [...new Set(validResults.flatMap(r => r.sports || []))].sort();
      const sportsDatasets = validResults.map((r, i) => ({
        label: r.name,
        data: allSports.map(sport => r.sports?.includes(sport) ? 1 : 0),
        backgroundColor: colors[i],
        borderRadius: 4
      }));

      compareChartInstances.sports = new Chart(document.getElementById('compareSportsChart'), {
        type: 'bar',
        data: {
          labels: allSports.map(s => s.length > 15 ? s.substring(0, 15) + '...' : s),
          datasets: sportsDatasets
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#888' } }
          },
          scales: {
            x: { grid: { display: false }, ticks: { color: '#888', font: { size: 10 } } },
            y: { display: false, max: 1.2 }
          }
        }
      });

      // Exclusive content
      buildExclusiveContent(validResults, colors);
    }

    function buildExclusiveContent(results, colors) {
      if (results.length < 2) return;

      const container = document.getElementById('exclusiveContent');
      let html = '';

      // Get all event IDs/titles for comparison
      const eventSets = results.map(r => new Set(r.filteredEvents?.map(e => e.Title) || []));

      results.forEach((r, i) => {
        const myEvents = r.filteredEvents || [];
        const otherSets = eventSets.filter((_, idx) => idx !== i);

        const exclusiveEvents = myEvents.filter(e =>
          otherSets.every(set => !set.has(e.Title))
        ).slice(0, 10);

        html += `
          <div class="exclusive-card" style="border-top: 3px solid ${colors[i]}">
            <h4>${r.flag} ${r.name} Exclusive (${exclusiveEvents.length}+ events)</h4>
            <div class="exclusive-list">
              ${exclusiveEvents.length === 0 ? '<p style="color: var(--text-secondary);">No exclusive events found</p>' :
                exclusiveEvents.map(e => `
                  <div class="exclusive-item">
                    <div class="title">${e.Title}</div>
                    <div class="meta">${e.Sport?.Title || 'Sports'} &bull; ${e.Competition?.Title || ''}</div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      });

      // Shared content
      if (results.length === 2) {
        const [a, b] = results;
        const aSet = new Set(a.filteredEvents?.map(e => e.Title) || []);
        const sharedEvents = (b.filteredEvents || []).filter(e => aSet.has(e.Title)).slice(0, 10);

        html += `
          <div class="exclusive-card" style="border-top: 3px solid var(--accent-secondary)">
            <h4>Shared Content (${sharedEvents.length}+ events)</h4>
            <div class="exclusive-list">
              ${sharedEvents.length === 0 ? '<p style="color: var(--text-secondary);">No shared events found</p>' :
                sharedEvents.map(e => `
                  <div class="exclusive-item">
                    <div class="title">${e.Title}</div>
                    <div class="meta">${e.Sport?.Title || 'Sports'} &bull; ${e.Competition?.Title || ''}</div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      }

      container.innerHTML = html;
    }

    // Initialize on page load
    initDatePicker();
    loadSavedTheme();

    // Analytics functionality
    let chartInstances = {};

    function openAnalytics() {
      if (allEvents.length === 0) return;

      // Get selected date and country for header
      const dateStr = document.getElementById('datePicker').value;
      const countrySelect = document.getElementById('countryPicker');
      const countryName = countrySelect.options[countrySelect.selectedIndex].text.replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '').trim();

      // Format the date nicely
      const [year, month, day] = dateStr.split('-');
      const dateObj = new Date(year, month - 1, day);
      const formattedDate = dateObj.toLocaleDateString([], { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' });

      // Update the header
      document.querySelector('.analytics-header h2').textContent = `DAZN Schedule Analytics for ${countryName} on ${formattedDate}`;

      document.getElementById('analyticsModal').style.display = 'block';
      document.body.style.overflow = 'hidden';

      generateAnalytics();
    }

    function closeAnalytics() {
      document.getElementById('analyticsModal').style.display = 'none';
      document.body.style.overflow = 'auto';

      // Destroy chart instances to prevent memory leaks
      Object.values(chartInstances).forEach(chart => chart.destroy());
      chartInstances = {};
    }

    document.getElementById('analyticsModal').addEventListener('click', (e) => {
      if (e.target.id === 'analyticsModal') closeAnalytics();
    });

    function generateAnalytics() {
      // Filter out "Live TV" events from analytics
      const events = allEvents.filter(e =>
        !e.Title?.toLowerCase().includes('live tv') &&
        !e.Sport?.Title?.toLowerCase().includes('live tv') &&
        !e.Competition?.Title?.toLowerCase().includes('live tv')
      );

      // Estimated duration by sport (in minutes) for events without end times
      const sportDurations = {
        'soccer': 120,
        'football': 180,
        'basketball': 150,
        'baseball': 180,
        'hockey': 150,
        'tennis': 120,
        'golf': 240,
        'boxing': 180,
        'mma': 180,
        'ufc': 180,
        'wrestling': 150,
        'cricket': 240,
        'rugby': 120,
        'motorsport': 150,
        'racing': 150,
        'cycling': 180,
        'default': 120
      };

      function getEstimatedDuration(sportTitle) {
        if (!sportTitle) return sportDurations.default;
        const sport = sportTitle.toLowerCase();
        for (const [key, duration] of Object.entries(sportDurations)) {
          if (sport.includes(key)) return duration;
        }
        return sportDurations.default;
      }

      // Helper to calculate duration in minutes
      function getEventDuration(event) {
        try {
          // First try actual end time
          if (event.End) {
            const start = new Date(event.Start).getTime();
            const end = new Date(event.End).getTime();
            if (!isNaN(start) && !isNaN(end) && end > start) {
              return (end - start) / (1000 * 60);
            }
          }

          // Try DurationInMillis
          if (event.DurationInMillis && event.DurationInMillis > 0) {
            return event.DurationInMillis / (1000 * 60);
          }

          // Fall back to estimated duration based on sport
          return getEstimatedDuration(event.Sport?.Title);
        } catch (e) {
          console.error('Duration calc error:', e);
        }
        return sportDurations.default;
      }

      // Calculate stats
      const totalEvents = events.length;
      const sports = {};
      const competitions = {};
      const hourlyData = new Array(24).fill(0);
      const sportBroadcastHours = {};
      let totalMinutes = 0;

      // New analytics data
      let freeCount = 0;
      let paidCount = 0;
      let geoRestrictedCount = 0;
      let has4k = 0;
      let hasHdr = 0;
      let hasMultiView = 0;
      let hasDownload = 0;
      const timeOfDayData = {
        'Early Morning (12am-6am)': new Array(24).fill(0),
        'Morning (6am-12pm)': new Array(24).fill(0),
        'Afternoon (12pm-6pm)': new Array(24).fill(0),
        'Evening (6pm-12am)': new Array(24).fill(0)
      };
      const sportByHour = {};

      events.forEach(event => {
        const sport = event.Sport?.Title || 'Other';
        const competition = event.Competition?.Title || 'Unknown';
        const startHour = new Date(event.Start).getHours() || 0;
        const duration = getEventDuration(event);

        sports[sport] = (sports[sport] || 0) + 1;
        competitions[competition] = (competitions[competition] || 0) + 1;
        hourlyData[startHour]++;
        sportBroadcastHours[sport] = (sportBroadcastHours[sport] || 0) + duration;
        totalMinutes += duration;

        // Subscription vs PPV (Pay-Per-View)
        const entitlements = event.EntitlementIds || [];
        const isPPV = entitlements.some(id => id.toLowerCase().includes('ppv'));
        if (isPPV) {
          paidCount++; // Using paidCount for PPV
        } else {
          freeCount++; // Using freeCount for standard subscription
        }

        // Geo-restricted
        if (event.IsGeoRestricted) geoRestrictedCount++;

        // Video quality features
        const heConfig = event.HeEventTypeConfig || {};
        if (heConfig.is4k || heConfig.is4kUpscaled) has4k++;
        if (heConfig.isHdr) hasHdr++;
        if (event.IsMultiView) hasMultiView++;
        if (event.IsDownloadable) hasDownload++;

        // Sport by hour for heatmap
        if (!sportByHour[sport]) {
          sportByHour[sport] = new Array(24).fill(0);
        }
        sportByHour[sport][startHour]++;
      });

      const totalHours = Math.round(totalMinutes / 60);
      const avgDuration = totalEvents > 0 ? Math.round(totalMinutes / totalEvents) : 0;
      const uniqueSports = Object.keys(sports).length;
      const uniqueCompetitions = Object.keys(competitions).length;
      const peakHour = hourlyData.indexOf(Math.max(...hourlyData));

      // Check how many events have actual vs estimated durations
      const eventsWithActualDuration = events.filter(e => e.End || e.DurationInMillis).length;
      const eventsWithEstimated = events.length - eventsWithActualDuration;
      console.log(`Duration stats: ${eventsWithActualDuration} actual, ${eventsWithEstimated} estimated`);
      console.log(`Total broadcast minutes: ${totalMinutes}, hours: ${totalMinutes/60}`);

      // Quick Stats - show different labels based on data quality
      const mostlyActual = eventsWithActualDuration > eventsWithEstimated;
      const broadcastLabel = mostlyActual ? 'Total Broadcast Time' : 'Est. Broadcast Time';
      const durationLabel = mostlyActual ? 'Avg Duration' : 'Est. Avg Duration';
      const tilde = mostlyActual ? '' : '~';

      document.getElementById('quickStats').innerHTML = `
        <div class="quick-stat-card">
          <div class="value">${totalEvents}</div>
          <div class="label">Total Events</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${tilde}${totalHours}h</div>
          <div class="label">${broadcastLabel}</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${tilde}${avgDuration}m</div>
          <div class="label">${durationLabel}</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${uniqueSports}</div>
          <div class="label">Sports Covered</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${uniqueCompetitions}</div>
          <div class="label">Competitions</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${peakHour}:00</div>
          <div class="label">Peak Hour</div>
        </div>
      `;

      // Chart colors
      const colors = [
        '#7c3aed', '#00d4ff', '#f97316', '#22c55e', '#ef4444',
        '#eab308', '#ec4899', '#06b6d4', '#8b5cf6', '#14b8a6',
        '#f43f5e', '#84cc16', '#6366f1', '#0ea5e9', '#a855f7'
      ];

      // Sports Pie Chart
      const sortedSports = Object.entries(sports).sort((a, b) => b[1] - a[1]);
      chartInstances.sportsPie = new Chart(document.getElementById('sportsPieChart'), {
        type: 'doughnut',
        data: {
          labels: sortedSports.map(s => s[0]),
          datasets: [{
            data: sortedSports.map(s => s[1]),
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#888', font: { size: 11 } }
            }
          }
        }
      });

      // Hourly Bar Chart
      chartInstances.hourlyBar = new Chart(document.getElementById('hourlyBarChart'), {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Events',
            data: hourlyData,
            backgroundColor: 'rgba(124, 58, 237, 0.7)',
            borderColor: '#7c3aed',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            }
          }
        }
      });

      // Broadcast Hours by Sport (Horizontal Bar)
      const sortedBroadcast = Object.entries(sportBroadcastHours)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      chartInstances.broadcastHours = new Chart(document.getElementById('broadcastHoursChart'), {
        type: 'bar',
        data: {
          labels: sortedBroadcast.map(s => s[0]),
          datasets: [{
            label: 'Hours',
            data: sortedBroadcast.map(s => Math.round(s[1] / 60 * 10) / 10),
            backgroundColor: colors,
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            },
            y: {
              grid: { display: false },
              ticks: { color: '#fff', font: { size: 11 } }
            }
          }
        }
      });

      // Top Competitions Chart
      const sortedComps = Object.entries(competitions)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      chartInstances.competitions = new Chart(document.getElementById('competitionsChart'), {
        type: 'bar',
        data: {
          labels: sortedComps.map(c => c[0].length > 25 ? c[0].substring(0, 25) + '...' : c[0]),
          datasets: [{
            label: 'Events',
            data: sortedComps.map(c => c[1]),
            backgroundColor: 'rgba(0, 212, 255, 0.7)',
            borderColor: '#00d4ff',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            },
            y: {
              grid: { display: false },
              ticks: { color: '#fff', font: { size: 10 } }
            }
          }
        }
      });

      // Subscription vs PPV Content Chart
      chartInstances.access = new Chart(document.getElementById('accessChart'), {
        type: 'doughnut',
        data: {
          labels: ['Subscription', 'PPV (Extra Cost)'],
          datasets: [{
            data: [freeCount, paidCount],
            backgroundColor: ['#7c3aed', '#f97316'],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#888', font: { size: 11 } }
            }
          }
        }
      });

      // Video Quality Features Chart
      chartInstances.quality = new Chart(document.getElementById('qualityChart'), {
        type: 'bar',
        data: {
          labels: ['4K', 'HDR', 'Multi-View', 'Downloadable'],
          datasets: [{
            label: 'Events',
            data: [has4k, hasHdr, hasMultiView, hasDownload],
            backgroundColor: ['#f97316', '#eab308', '#06b6d4', '#22c55e'],
            borderWidth: 0,
            borderRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { display: false },
              ticks: { color: '#fff' }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            }
          }
        }
      });

      // Time of Day Heatmap (Sport by Hour)
      const heatmapContainer = document.getElementById('timeHeatmap');
      const sortedSportsForHeatmap = Object.entries(sportByHour)
        .sort((a, b) => b[1].reduce((s, v) => s + v, 0) - a[1].reduce((s, v) => s + v, 0))
        .slice(0, 8);

      // Find max value for color scaling
      let maxHeatValue = 0;
      sortedSportsForHeatmap.forEach(([sport, hours]) => {
        hours.forEach(v => { if (v > maxHeatValue) maxHeatValue = v; });
      });

      // Build heatmap HTML
      let heatmapHTML = '<div class="heatmap-row"><div class="heatmap-label"></div>';
      for (let h = 0; h < 24; h++) {
        heatmapHTML += `<div class="heatmap-header">${h}</div>`;
      }
      heatmapHTML += '</div>';

      sortedSportsForHeatmap.forEach(([sport, hours]) => {
        const shortSport = sport.length > 8 ? sport.substring(0, 8) + '..' : sport;
        heatmapHTML += `<div class="heatmap-row"><div class="heatmap-label">${shortSport}</div>`;
        hours.forEach((count, hour) => {
          const intensity = maxHeatValue > 0 ? count / maxHeatValue : 0;
          let bgColor;
          if (count === 0) {
            bgColor = '#1e1e2e';
          } else if (intensity < 0.33) {
            bgColor = '#3b1d5c';
          } else if (intensity < 0.66) {
            bgColor = '#7c3aed';
          } else {
            bgColor = '#00d4ff';
          }
          heatmapHTML += `<div class="heatmap-cell" style="background-color: ${bgColor}" title="${sport} at ${hour}:00 - ${count} event${count !== 1 ? 's' : ''}"></div>`;
        });
        heatmapHTML += '</div>';
      });

      heatmapContainer.innerHTML = heatmapHTML;

      // Top Events by Duration Table (sorted by estimated/actual duration)
      const eventsWithDuration = events.map(e => ({
        ...e,
        duration: getEventDuration(e),
        hasActualDuration: !!(e.End || e.DurationInMillis)
      })).sort((a, b) => b.duration - a.duration).slice(0, 10);

      const tbody = document.getElementById('topEventsBody');
      tbody.innerHTML = eventsWithDuration.map((event, i) => {
        const hours = Math.floor(event.duration / 60);
        const mins = Math.round(event.duration % 60);
        const durationStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;
        const estLabel = event.hasActualDuration ? '' : ' ~';

        return `
          <tr>
            <td class="rank">${i + 1}</td>
            <td>${event.Title.length > 40 ? event.Title.substring(0, 40) + '...' : event.Title}</td>
            <td class="sport-cell">${event.Sport?.Title || 'N/A'}</td>
            <td class="duration">${estLabel}${durationStr}</td>
          </tr>
        `;
      }).join('');
    }
  </script>
</body>
</html>
