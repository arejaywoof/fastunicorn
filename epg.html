<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>DAZN EPG Browser</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
      color: #f0f0f0;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.5rem;
      margin: 0;
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .header p {
      color: #888;
      margin-top: 5px;
    }

    /* Controls Section */
    #controls {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      align-items: center;
      margin-bottom: 25px;
      padding: 20px;
      background: rgba(255,255,255,0.05);
      border-radius: 16px;
      backdrop-filter: blur(10px);
    }

    .date-section {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .date-nav-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 1rem;
    }

    .date-nav-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: translateY(-1px);
    }

    .date-nav-btn.active {
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      border-color: transparent;
    }

    #datePicker {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
    }

    #datePicker::-webkit-calendar-picker-indicator {
      filter: invert(1);
      cursor: pointer;
    }

    .country-wrapper {
      position: relative;
    }

    #countryPicker {
      padding: 10px 14px;
      font-size: 1rem;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.2);
      background: rgba(255,255,255,0.1);
      color: #fff;
      cursor: pointer;
      min-width: 200px;
      appearance: none;
      -webkit-appearance: none;
    }

    #countryPicker option {
      background: #1a1a2e;
      color: #fff;
      padding: 10px;
    }

    .go-btn {
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      border: none;
      color: #fff;
      padding: 12px 28px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: all 0.3s;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .go-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(124, 58, 237, 0.4);
    }

    .go-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    /* Stats Bar */
    .stats-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .stat-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.1);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9rem;
    }

    .stat-badge.primary {
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
    }

    /* Sport Filter Tabs */
    .sport-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-bottom: 25px;
    }

    .sport-tab {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.15);
      color: #aaa;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.85rem;
    }

    .sport-tab:hover {
      background: rgba(255,255,255,0.15);
      color: #fff;
    }

    .sport-tab.active {
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      border-color: transparent;
      color: #fff;
    }

    .sport-tab .count {
      background: rgba(0,0,0,0.3);
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 6px;
      font-size: 0.8rem;
    }

    /* Event Container */
    #eventContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 20px;
      max-width: 1600px;
      margin: 0 auto;
    }

    /* Event Cards */
    .eventCard {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      border-radius: 16px;
      overflow: hidden;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255,255,255,0.08);
      position: relative;
    }

    .eventCard:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 40px rgba(0,0,0,0.4);
      border-color: rgba(124, 58, 237, 0.5);
    }

    .eventCard .image-wrapper {
      position: relative;
      overflow: hidden;
    }

    .eventCard img {
      width: 100%;
      height: 180px;
      object-fit: cover;
      transition: transform 0.3s;
    }

    .eventCard:hover img {
      transform: scale(1.05);
    }

    .eventCard .no-image {
      width: 100%;
      height: 180px;
      background: linear-gradient(135deg, #2d2d44, #1a1a2e);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      color: #444;
    }

    .live-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      background: #ef4444;
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 700;
      text-transform: uppercase;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .sport-badge {
      position: absolute;
      top: 12px;
      right: 12px;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(4px);
      color: white;
      padding: 4px 10px;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .eventCard .content {
      padding: 16px;
    }

    .eventCard .competition {
      font-size: 0.8rem;
      color: #00d4ff;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .eventCard h3 {
      margin: 0 0 12px 0;
      font-size: 1.1rem;
      font-weight: 600;
      line-height: 1.3;
      color: #fff;
    }

    .eventCard .time-info {
      display: flex;
      align-items: center;
      gap: 8px;
      color: #888;
      font-size: 0.85rem;
    }

    .eventCard .time-info svg {
      width: 16px;
      height: 16px;
      fill: currentColor;
    }

    /* Loading State */
    .loading {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      color: #888;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255,255,255,0.1);
      border-top-color: #7c3aed;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 15px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Modal */
    #eventDetails {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(8px);
      z-index: 9999;
      padding: 20px;
      overflow-y: auto;
    }

    .modal-content {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      max-width: 500px;
      margin: 50px auto;
      border-radius: 20px;
      overflow: hidden;
      position: relative;
      border: 1px solid rgba(255,255,255,0.1);
    }

    .modal-content img {
      width: 100%;
      height: 220px;
      object-fit: cover;
    }

    .modal-content .modal-body {
      padding: 24px;
    }

    .modal-content h2 {
      margin: 0 0 8px 0;
      font-size: 1.5rem;
      color: #fff;
    }

    .modal-content .competition-tag {
      display: inline-block;
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 0.8rem;
      margin-bottom: 16px;
    }

    .modal-content .description {
      color: #aaa;
      line-height: 1.6;
      margin-bottom: 20px;
    }

    .modal-content .info-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .modal-content .info-item {
      background: rgba(255,255,255,0.05);
      padding: 12px;
      border-radius: 10px;
    }

    .modal-content .info-item label {
      display: block;
      font-size: 0.75rem;
      color: #888;
      margin-bottom: 4px;
      text-transform: uppercase;
    }

    .modal-content .info-item span {
      font-weight: 500;
      color: #fff;
    }

    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: rgba(0,0,0,0.6);
      border: none;
      color: white;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .close-btn:hover {
      background: rgba(0,0,0,0.8);
      transform: scale(1.1);
    }

    /* Empty/Error States */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #888;
    }

    .empty-state .icon {
      font-size: 4rem;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .error-state {
      text-align: center;
      padding: 40px 20px;
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      color: #f87171;
    }

    /* Analytics Button */
    .analytics-btn {
      background: rgba(255,255,255,0.1);
      border: 1px solid rgba(255,255,255,0.2);
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .analytics-btn:hover {
      background: linear-gradient(135deg, #7c3aed, #00d4ff);
      border-color: transparent;
    }

    .analytics-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Analytics Modal */
    #analyticsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(8px);
      z-index: 10000;
      padding: 20px;
      overflow-y: auto;
    }

    .analytics-container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .analytics-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .analytics-header h2 {
      margin: 0;
      font-size: 1.8rem;
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .analytics-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }

    .analytics-close:hover {
      background: rgba(255,255,255,0.2);
    }

    /* Quick Stats Grid */
    .quick-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .quick-stat-card {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      border-radius: 12px;
      padding: 20px;
      text-align: center;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .quick-stat-card .value {
      font-size: 2rem;
      font-weight: 700;
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .quick-stat-card .label {
      font-size: 0.85rem;
      color: #888;
      margin-top: 5px;
    }

    /* Charts Grid */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .chart-card {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .chart-card h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      color: #fff;
    }

    .chart-wrapper {
      position: relative;
      height: 300px;
    }

    /* Top Events Table */
    .top-events-card {
      background: linear-gradient(145deg, #1e1e2e, #252540);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.08);
    }

    .top-events-card h3 {
      margin: 0 0 15px 0;
      font-size: 1.1rem;
      color: #fff;
    }

    .top-events-table {
      width: 100%;
      border-collapse: collapse;
    }

    .top-events-table th,
    .top-events-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(255,255,255,0.08);
    }

    .top-events-table th {
      color: #888;
      font-weight: 500;
      font-size: 0.8rem;
      text-transform: uppercase;
    }

    .top-events-table td {
      color: #fff;
      font-size: 0.9rem;
    }

    .top-events-table tr:last-child td {
      border-bottom: none;
    }

    .top-events-table .rank {
      width: 40px;
      color: #7c3aed;
      font-weight: 700;
    }

    .top-events-table .duration {
      color: #00d4ff;
      font-weight: 600;
    }

    .top-events-table .sport-cell {
      color: #888;
      font-size: 0.85rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .header h1 {
        font-size: 1.8rem;
      }

      #controls {
        padding: 15px;
      }

      .date-section {
        width: 100%;
        justify-content: center;
      }

      #eventContainer {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .chart-wrapper {
        height: 250px;
      }

      .quick-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
  </style>
</head>
<body>

  <div class="header">
    <h1>DAZN EPG Browser</h1>
    <p>Browse sports events from around the world</p>
  </div>

  <div id="controls">
    <div class="date-section">
      <button class="date-nav-btn" onclick="changeDate(-1)">&#9664;</button>
      <button class="date-nav-btn" id="todayBtn" onclick="setToday()">Today</button>
      <input type="date" id="datePicker">
      <button class="date-nav-btn" id="tomorrowBtn" onclick="setTomorrow()">Tomorrow</button>
      <button class="date-nav-btn" onclick="changeDate(1)">&#9654;</button>
    </div>

    <div class="country-wrapper">
      <select id="countryPicker">
        <option value="us">&#x1F1FA;&#x1F1F8; United States</option>
        <option value="ca">&#x1F1E8;&#x1F1E6; Canada</option>
        <option value="gb">&#x1F1EC;&#x1F1E7; United Kingdom</option>
        <option value="de">&#x1F1E9;&#x1F1EA; Germany</option>
        <option value="fr">&#x1F1EB;&#x1F1F7; France</option>
        <option value="es">&#x1F1EA;&#x1F1F8; Spain</option>
        <option value="it">&#x1F1EE;&#x1F1F9; Italy</option>
        <option value="au">&#x1F1E6;&#x1F1FA; Australia</option>
        <option value="nz">&#x1F1F3;&#x1F1FF; New Zealand</option>
        <option value="jp">&#x1F1EF;&#x1F1F5; Japan</option>
        <option value="kr">&#x1F1F0;&#x1F1F7; South Korea</option>
        <option value="mx">&#x1F1F2;&#x1F1FD; Mexico</option>
        <option value="br">&#x1F1E7;&#x1F1F7; Brazil</option>
        <option value="ar">&#x1F1E6;&#x1F1F7; Argentina</option>
        <option value="se">&#x1F1F8;&#x1F1EA; Sweden</option>
        <option value="no">&#x1F1F3;&#x1F1F4; Norway</option>
        <option value="fi">&#x1F1EB;&#x1F1EE; Finland</option>
        <option value="dk">&#x1F1E9;&#x1F1F0; Denmark</option>
        <option value="nl">&#x1F1F3;&#x1F1F1; Netherlands</option>
        <option value="be">&#x1F1E7;&#x1F1EA; Belgium</option>
        <option value="ch">&#x1F1E8;&#x1F1ED; Switzerland</option>
        <option value="at">&#x1F1E6;&#x1F1F9; Austria</option>
        <option value="ie">&#x1F1EE;&#x1F1EA; Ireland</option>
        <option value="pl">&#x1F1F5;&#x1F1F1; Poland</option>
        <option value="pt">&#x1F1F5;&#x1F1F9; Portugal</option>
        <option value="cz">&#x1F1E8;&#x1F1FF; Czech Republic</option>
        <option value="hu">&#x1F1ED;&#x1F1FA; Hungary</option>
        <option value="gr">&#x1F1EC;&#x1F1F7; Greece</option>
        <option value="ro">&#x1F1F7;&#x1F1F4; Romania</option>
        <option value="bg">&#x1F1E7;&#x1F1EC; Bulgaria</option>
        <option value="ru">&#x1F1F7;&#x1F1FA; Russia</option>
        <option value="cn">&#x1F1E8;&#x1F1F3; China</option>
        <option value="in">&#x1F1EE;&#x1F1F3; India</option>
        <option value="za">&#x1F1FF;&#x1F1E6; South Africa</option>
        <option value="ae">&#x1F1E6;&#x1F1EA; United Arab Emirates</option>
        <option value="tr">&#x1F1F9;&#x1F1F7; Turkey</option>
        <option value="il">&#x1F1EE;&#x1F1F1; Israel</option>
        <option value="sg">&#x1F1F8;&#x1F1EC; Singapore</option>
        <option value="hk">&#x1F1ED;&#x1F1F0; Hong Kong</option>
      </select>
    </div>

    <button class="go-btn" id="goBtn" onclick="loadEPG()">Load Events</button>
  </div>

  <div class="stats-bar" id="statsBar" style="display: none;">
    <span class="stat-badge primary" id="eventCount"></span>
    <span class="stat-badge" id="dateDisplay"></span>
    <button class="analytics-btn" id="analyticsBtn" onclick="openAnalytics()">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
      Analytics
    </button>
  </div>

  <div class="sport-filters" id="sportFilters" style="display: none;"></div>

  <div id="eventContainer"></div>

  <div id="eventDetails">
    <div class="modal-content" id="modalContent"></div>
  </div>

  <!-- Analytics Modal -->
  <div id="analyticsModal">
    <div class="analytics-container">
      <div class="analytics-header">
        <h2>Daily Analytics</h2>
        <button class="analytics-close" onclick="closeAnalytics()">&times;</button>
      </div>

      <div class="quick-stats" id="quickStats"></div>

      <div class="charts-grid">
        <div class="chart-card">
          <h3>Events by Sport</h3>
          <div class="chart-wrapper">
            <canvas id="sportsPieChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Events by Hour</h3>
          <div class="chart-wrapper">
            <canvas id="hourlyBarChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Broadcast Hours by Sport</h3>
          <div class="chart-wrapper">
            <canvas id="broadcastHoursChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>Top Competitions</h3>
          <div class="chart-wrapper">
            <canvas id="competitionsChart"></canvas>
          </div>
        </div>
      </div>

      <div class="top-events-card">
        <h3>Longest Broadcasts</h3>
        <table class="top-events-table" id="topEventsTable">
          <thead>
            <tr>
              <th>#</th>
              <th>Event</th>
              <th>Sport</th>
              <th>Duration</th>
            </tr>
          </thead>
          <tbody id="topEventsBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const eventContainer = document.getElementById("eventContainer");
    const statsBar = document.getElementById("statsBar");
    const sportFilters = document.getElementById("sportFilters");
    let allEvents = [];
    let currentFilter = 'all';

    // Sport icons mapping
    const sportIcons = {
      'Soccer': '&#9917;',
      'Football': '&#127944;',
      'Basketball': '&#127936;',
      'Baseball': '&#9918;',
      'Hockey': '&#127954;',
      'Tennis': '&#127934;',
      'Golf': '&#9971;',
      'Boxing': '&#129354;',
      'MMA': '&#129354;',
      'UFC': '&#129354;',
      'Racing': '&#127950;',
      'Motor Sports': '&#127950;',
      'Cricket': '&#127951;',
      'Rugby': '&#127937;',
      'default': '&#127941;'
    };

    function getSportIcon(sportTitle) {
      for (const [key, icon] of Object.entries(sportIcons)) {
        if (sportTitle && sportTitle.toLowerCase().includes(key.toLowerCase())) {
          return icon;
        }
      }
      return sportIcons.default;
    }

    // Initialize with today's date
    function initDatePicker() {
      const today = new Date();
      const formatted = today.toISOString().split('T')[0];
      document.getElementById('datePicker').value = formatted;
      updateDateButtons();
    }

    function setToday() {
      const today = new Date();
      document.getElementById('datePicker').value = today.toISOString().split('T')[0];
      updateDateButtons();
    }

    function setTomorrow() {
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      document.getElementById('datePicker').value = tomorrow.toISOString().split('T')[0];
      updateDateButtons();
    }

    function changeDate(days) {
      const picker = document.getElementById('datePicker');
      const current = new Date(picker.value);
      current.setDate(current.getDate() + days);
      picker.value = current.toISOString().split('T')[0];
      updateDateButtons();
    }

    function updateDateButtons() {
      const picker = document.getElementById('datePicker');
      const selected = picker.value;
      const today = new Date().toISOString().split('T')[0];
      const tomorrow = new Date();
      tomorrow.setDate(tomorrow.getDate() + 1);
      const tomorrowStr = tomorrow.toISOString().split('T')[0];

      document.getElementById('todayBtn').classList.toggle('active', selected === today);
      document.getElementById('tomorrowBtn').classList.toggle('active', selected === tomorrowStr);
    }

    document.getElementById('datePicker').addEventListener('change', updateDateButtons);

    function showLoading() {
      eventContainer.innerHTML = `
        <div class="loading" style="grid-column: 1 / -1;">
          <div class="spinner"></div>
          <p>Loading events...</p>
        </div>
      `;
      statsBar.style.display = 'none';
      sportFilters.style.display = 'none';
    }

    function isEventLive(event) {
      const now = new Date();
      const start = new Date(event.Start);
      const end = new Date(event.End);
      return now >= start && now <= end;
    }

    function formatTime(dateStr) {
      return new Date(dateStr).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function formatDate(dateStr) {
      const [year, month, day] = dateStr.split('-');
      const date = new Date(year, month - 1, day);
      return date.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric' });
    }

    function showEventDetails(eventData) {
      const modal = document.getElementById("eventDetails");
      const content = document.getElementById("modalContent");
      const imgId = eventData.Image?.Id;
      const imageUrl = imgId ? `https://image.discovery.indazn.com/ca/v3/ca/none/${imgId}/fill/none/top/none/50/500/280/webp/image` : "";

      content.innerHTML = `
        <button class="close-btn" onclick="closeModal()">&times;</button>
        ${imageUrl ? `<img src="${imageUrl}" alt="Event image">` : `<div class="no-image" style="height:220px;">${getSportIcon(eventData.Sport?.Title)}</div>`}
        <div class="modal-body">
          <h2>${eventData.Title}</h2>
          ${eventData.Competition?.Title ? `<span class="competition-tag">${eventData.Competition.Title}</span>` : ''}
          ${eventData.Description ? `<p class="description">${eventData.Description}</p>` : ''}
          <div class="info-grid">
            <div class="info-item">
              <label>Sport</label>
              <span>${eventData.Sport?.Title || 'N/A'}</span>
            </div>
            <div class="info-item">
              <label>Status</label>
              <span>${isEventLive(eventData) ? '&#x1F534; LIVE' : 'Scheduled'}</span>
            </div>
            <div class="info-item">
              <label>Start Time</label>
              <span>${formatTime(eventData.Start)}</span>
            </div>
            <div class="info-item">
              <label>End Time</label>
              <span>${formatTime(eventData.End)}</span>
            </div>
          </div>
        </div>
      `;

      modal.style.display = "block";
      document.body.style.overflow = "hidden";
    }

    function closeModal() {
      document.getElementById("eventDetails").style.display = "none";
      document.body.style.overflow = "auto";
    }

    document.getElementById("eventDetails").addEventListener("click", (e) => {
      if (e.target.id === "eventDetails") closeModal();
    });

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    function buildSportFilters(events) {
      const sportCounts = {};
      events.forEach(e => {
        const sport = e.Sport?.Title || 'Other';
        sportCounts[sport] = (sportCounts[sport] || 0) + 1;
      });

      const sorted = Object.entries(sportCounts).sort((a, b) => b[1] - a[1]);

      let html = `<button class="sport-tab ${currentFilter === 'all' ? 'active' : ''}" onclick="filterBySport('all')">
        All<span class="count">${events.length}</span>
      </button>`;

      sorted.forEach(([sport, count]) => {
        html += `<button class="sport-tab ${currentFilter === sport ? 'active' : ''}" onclick="filterBySport('${sport.replace(/'/g, "\\'")}')">
          ${sport}<span class="count">${count}</span>
        </button>`;
      });

      sportFilters.innerHTML = html;
      sportFilters.style.display = 'flex';
    }

    function filterBySport(sport) {
      currentFilter = sport;
      renderEvents(allEvents);
      buildSportFilters(allEvents);
    }

    function renderEvents(events) {
      const filtered = currentFilter === 'all'
        ? events
        : events.filter(e => (e.Sport?.Title || 'Other') === currentFilter);

      if (filtered.length === 0) {
        eventContainer.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1;">
            <div class="icon">&#128531;</div>
            <h3>No events found</h3>
            <p>Try selecting a different sport or date</p>
          </div>
        `;
        return;
      }

      // Sort by start time
      filtered.sort((a, b) => new Date(a.Start) - new Date(b.Start));

      eventContainer.innerHTML = '';
      filtered.forEach(event => {
        const eventCard = document.createElement("div");
        eventCard.className = "eventCard";

        const imgId = event.Image?.Id;
        const imageUrl = imgId ? `https://image.discovery.indazn.com/ca/v3/ca/none/${imgId}/fill/none/top/none/50/334/187/webp/image` : "";
        const isLive = isEventLive(event);
        const sportTitle = event.Sport?.Title || 'Sports';

        eventCard.innerHTML = `
          <div class="image-wrapper">
            ${imageUrl
              ? `<img src="${imageUrl}" alt="Event image" loading="lazy">`
              : `<div class="no-image">${getSportIcon(sportTitle)}</div>`}
            ${isLive ? '<div class="live-badge">Live</div>' : ''}
            <div class="sport-badge">${sportTitle}</div>
          </div>
          <div class="content">
            ${event.Competition?.Title ? `<div class="competition">${event.Competition.Title}</div>` : ''}
            <h3>${event.Title}</h3>
            <div class="time-info">
              <svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>
              <span>${formatTime(event.Start)} - ${formatTime(event.End)}</span>
            </div>
          </div>
        `;

        eventCard.addEventListener("click", () => showEventDetails(event));
        eventContainer.appendChild(eventCard);
      });
    }

    function loadEPG() {
      const date = document.getElementById("datePicker").value;
      const country = document.getElementById("countryPicker").value;
      const epgUrl = `https://epg.discovery.indazn.com/ca/v2/Epg?date=${date}&country=${country}&languageCode=en&openBrowse=false&timeZoneOffset=-300`;

      showLoading();
      currentFilter = 'all';

      fetch(epgUrl)
        .then(response => response.json())
        .then(data => {
          const jsonString = JSON.stringify(data);
          if (jsonString.includes("Invalid Country.")) {
            eventContainer.innerHTML = `
              <div class="error-state" style="grid-column: 1 / -1;">
                <h3>&#9888; Country Not Supported</h3>
                <p>The selected country is not available from the EPG provider.</p>
              </div>
            `;
            statsBar.style.display = 'none';
            sportFilters.style.display = 'none';
            return;
          }

          allEvents = data.Tiles || [];

          if (allEvents.length === 0) {
            eventContainer.innerHTML = `
              <div class="empty-state" style="grid-column: 1 / -1;">
                <div class="icon">&#128247;</div>
                <h3>No events scheduled</h3>
                <p>There are no events for this date and country</p>
              </div>
            `;
            statsBar.style.display = 'none';
            sportFilters.style.display = 'none';
            return;
          }

          // Update stats
          document.getElementById("eventCount").textContent = `${allEvents.length} Events`;
          document.getElementById("dateDisplay").textContent = formatDate(date);
          statsBar.style.display = 'flex';

          buildSportFilters(allEvents);
          renderEvents(allEvents);
        })
        .catch(error => {
          console.error("Error fetching EPG:", error);
          eventContainer.innerHTML = `
            <div class="error-state" style="grid-column: 1 / -1;">
              <h3>&#10060; Failed to Load</h3>
              <p>Could not fetch EPG data. Please try again.</p>
            </div>
          `;
          statsBar.style.display = 'none';
          sportFilters.style.display = 'none';
        });
    }

    // Initialize on page load
    initDatePicker();

    // Analytics functionality
    let chartInstances = {};

    function openAnalytics() {
      if (allEvents.length === 0) return;

      document.getElementById('analyticsModal').style.display = 'block';
      document.body.style.overflow = 'hidden';

      generateAnalytics();
    }

    function closeAnalytics() {
      document.getElementById('analyticsModal').style.display = 'none';
      document.body.style.overflow = 'auto';

      // Destroy chart instances to prevent memory leaks
      Object.values(chartInstances).forEach(chart => chart.destroy());
      chartInstances = {};
    }

    document.getElementById('analyticsModal').addEventListener('click', (e) => {
      if (e.target.id === 'analyticsModal') closeAnalytics();
    });

    function generateAnalytics() {
      // Filter out "Live TV" events from analytics
      const events = allEvents.filter(e =>
        !e.Title?.toLowerCase().includes('live tv') &&
        !e.Sport?.Title?.toLowerCase().includes('live tv') &&
        !e.Competition?.Title?.toLowerCase().includes('live tv')
      );

      // Helper to parse date strings properly
      function parseEventDate(dateStr) {
        if (!dateStr) return null;
        // Handle ISO format or other formats
        const d = new Date(dateStr);
        if (!isNaN(d.getTime())) return d;
        return null;
      }

      // Calculate stats
      const totalEvents = events.length;
      const sports = {};
      const competitions = {};
      const hourlyData = new Array(24).fill(0);
      const sportBroadcastHours = {};
      let totalMinutes = 0;

      events.forEach(event => {
        const sport = event.Sport?.Title || 'Other';
        const competition = event.Competition?.Title || 'Unknown';
        const startDate = parseEventDate(event.Start);
        const endDate = parseEventDate(event.End);
        const startHour = startDate ? startDate.getHours() : 0;

        let duration = 0;
        if (startDate && endDate && endDate > startDate) {
          duration = (endDate - startDate) / (1000 * 60);
        }

        sports[sport] = (sports[sport] || 0) + 1;
        competitions[competition] = (competitions[competition] || 0) + 1;
        hourlyData[startHour]++;
        sportBroadcastHours[sport] = (sportBroadcastHours[sport] || 0) + duration;
        totalMinutes += duration;
      });

      const totalHours = Math.round(totalMinutes / 60);
      const avgDuration = totalEvents > 0 ? Math.round(totalMinutes / totalEvents) : 0;
      const uniqueSports = Object.keys(sports).length;
      const uniqueCompetitions = Object.keys(competitions).length;
      const peakHour = hourlyData.indexOf(Math.max(...hourlyData));

      // Quick Stats
      document.getElementById('quickStats').innerHTML = `
        <div class="quick-stat-card">
          <div class="value">${totalEvents}</div>
          <div class="label">Total Events</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${totalHours}h</div>
          <div class="label">Total Broadcast Time</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${avgDuration}m</div>
          <div class="label">Avg Event Duration</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${uniqueSports}</div>
          <div class="label">Sports Covered</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${uniqueCompetitions}</div>
          <div class="label">Competitions</div>
        </div>
        <div class="quick-stat-card">
          <div class="value">${peakHour}:00</div>
          <div class="label">Peak Hour</div>
        </div>
      `;

      // Chart colors
      const colors = [
        '#7c3aed', '#00d4ff', '#f97316', '#22c55e', '#ef4444',
        '#eab308', '#ec4899', '#06b6d4', '#8b5cf6', '#14b8a6',
        '#f43f5e', '#84cc16', '#6366f1', '#0ea5e9', '#a855f7'
      ];

      // Sports Pie Chart
      const sortedSports = Object.entries(sports).sort((a, b) => b[1] - a[1]);
      chartInstances.sportsPie = new Chart(document.getElementById('sportsPieChart'), {
        type: 'doughnut',
        data: {
          labels: sortedSports.map(s => s[0]),
          datasets: [{
            data: sortedSports.map(s => s[1]),
            backgroundColor: colors,
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'right',
              labels: { color: '#888', font: { size: 11 } }
            }
          }
        }
      });

      // Hourly Bar Chart
      chartInstances.hourlyBar = new Chart(document.getElementById('hourlyBarChart'), {
        type: 'bar',
        data: {
          labels: Array.from({length: 24}, (_, i) => `${i}:00`),
          datasets: [{
            label: 'Events',
            data: hourlyData,
            backgroundColor: 'rgba(124, 58, 237, 0.7)',
            borderColor: '#7c3aed',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888', font: { size: 10 } }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            }
          }
        }
      });

      // Broadcast Hours by Sport (Horizontal Bar)
      const sortedBroadcast = Object.entries(sportBroadcastHours)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);

      chartInstances.broadcastHours = new Chart(document.getElementById('broadcastHoursChart'), {
        type: 'bar',
        data: {
          labels: sortedBroadcast.map(s => s[0]),
          datasets: [{
            label: 'Hours',
            data: sortedBroadcast.map(s => Math.round(s[1] / 60 * 10) / 10),
            backgroundColor: colors,
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            },
            y: {
              grid: { display: false },
              ticks: { color: '#fff', font: { size: 11 } }
            }
          }
        }
      });

      // Top Competitions Chart
      const sortedComps = Object.entries(competitions)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 8);

      chartInstances.competitions = new Chart(document.getElementById('competitionsChart'), {
        type: 'bar',
        data: {
          labels: sortedComps.map(c => c[0].length > 25 ? c[0].substring(0, 25) + '...' : c[0]),
          datasets: [{
            label: 'Events',
            data: sortedComps.map(c => c[1]),
            backgroundColor: 'rgba(0, 212, 255, 0.7)',
            borderColor: '#00d4ff',
            borderWidth: 1,
            borderRadius: 4
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#888' },
              beginAtZero: true
            },
            y: {
              grid: { display: false },
              ticks: { color: '#fff', font: { size: 10 } }
            }
          }
        }
      });

      // Top Events by Duration Table
      const eventsWithDuration = events.map(e => {
        const start = parseEventDate(e.Start);
        const end = parseEventDate(e.End);
        let dur = 0;
        if (start && end && end > start) {
          dur = (end - start) / (1000 * 60);
        }
        return { ...e, duration: dur };
      }).filter(e => e.duration > 0).sort((a, b) => b.duration - a.duration).slice(0, 10);

      const tbody = document.getElementById('topEventsBody');
      tbody.innerHTML = eventsWithDuration.map((event, i) => {
        const hours = Math.floor(event.duration / 60);
        const mins = Math.round(event.duration % 60);
        const durationStr = hours > 0 ? `${hours}h ${mins}m` : `${mins}m`;

        return `
          <tr>
            <td class="rank">${i + 1}</td>
            <td>${event.Title.length > 40 ? event.Title.substring(0, 40) + '...' : event.Title}</td>
            <td class="sport-cell">${event.Sport?.Title || 'N/A'}</td>
            <td class="duration">${durationStr}</td>
          </tr>
        `;
      }).join('');
    }
  </script>
</body>
</html>
